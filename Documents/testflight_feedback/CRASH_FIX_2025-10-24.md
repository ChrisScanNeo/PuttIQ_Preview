# Audio Engine Crash Fix - October 24, 2025

## Issue Summary

**Reported Issue:** App crashes immediately when opening and going straight to detector mode (Listen Mode)

**Error Message:**
```
Failed to start detector: failed to start recording, Error: Error: could not start the audio engine.
the operation couldn't be completed. (com.apple.coreaudio.avfaudio error -10868.)
```

**TestFlight Feedback:** User reported "Changing modes" crash (see feedback.json and crashlog.crash)

## Root Cause

The crash was caused by an **AVAudioEngine format conflict** between expo-video and expo-audio-stream:

1. **expo-video** (VideoManager.swift) automatically sets the audio session to `.playback` mode with `.moviePlayback` category when video starts playing
2. When user taps "Listen Mode", **expo-audio-stream** attempts to install a recording tap on the audio engine
3. The audio engine crashes with error -10868 because:
   - The audio session is in playback-only mode (incompatible with recording)
   - The audio engine may already be running with an incompatible format
   - No tap cleanup was performed before attempting to install a new tap

**Evidence from crash log:**
- Thread 2: VideoManager.setAudioSession() was active
- Thread 6: AudioSessionManager.startRecording() crashed trying to installTap at line 429
- Both threads competed for AVAudioSession ownership

## Solution Implemented

### 1. Enhanced Native Audio Stream Module Patch

Modified `@cjblack/expo-audio-stream` iOS implementation to properly handle audio engine state before installing tap:

**File:** `node_modules/@cjblack/expo-audio-stream/ios/AudioSessionManager.swift`

**Changes:**
```swift
// Step 1: Stop the audio engine if it's running (prevents format conflicts)
if audioEngine.isRunning {
    Logger.debug("Debug: Stopping audio engine before tap installation")
    audioEngine.stop()
}

// Step 2: Remove any existing tap (prevents "tap already installed" error)
Logger.debug("Debug: Checking for existing tap before installation")
audioEngine.inputNode.removeTap(onBus: 0)

// Step 3: Validate format compatibility
let inputNodeFormat = audioEngine.inputNode.inputFormat(forBus: 0)
Logger.debug("Debug: Input node format - SR: \(inputNodeFormat.sampleRate)Hz, CH: \(inputNodeFormat.channelCount)")
Logger.debug("Debug: Requested format - SR: \(audioFormat.sampleRate)Hz, CH: \(audioFormat.channelCount)")

// Step 4: Install tap
audioEngine.inputNode.installTap(onBus: 0, bufferSize: 1024, format: audioFormat) { ... }
```

**Why this works:**
- Stopping the audio engine releases any format locks
- Removing existing tap prevents "tap already exists" conflicts
- Format validation logging helps debug future issues
- Proper cleanup sequence ensures clean state before installation

### 2. Added Retry Logic in JavaScript Layer

Modified `VideoSyncDetectorV2.js` to handle transient audio session conflicts:

**File:** `services/dsp/VideoSyncDetectorV2.js`

**Changes:**
- Added retry logic (2 attempts) with 300ms delay between retries
- Specifically handles error -10868 and related audio engine errors
- Provides user-friendly error messages when all retries fail
- Different errors (non-format issues) are not retried

**Code:**
```javascript
async startAudioStreamRecording() {
  const maxRetries = 2;
  let lastError = null;

  for (let attempt = 1; attempt <= maxRetries; attempt++) {
    try {
      // Attempt to start recording
      const result = await this.audioStreamModule.startRecording(recordingConfig);
      return; // Success!
    } catch (error) {
      // Check if this is a format error
      const isFormatError = errorMsg.includes('-10868') ||
                           errorMsg.includes('could not start the audio engine');

      if (isFormatError && attempt < maxRetries) {
        await new Promise(resolve => setTimeout(resolve, 300));
      } else if (!isFormatError) {
        throw error; // Don't retry non-format errors
      }
    }
  }

  // All retries failed
  throw new Error('Failed to start recording after 2 attempts...');
}
```

### 3. Improved Error Messages

Added user-friendly error messages in the start() method to guide users when audio conflicts occur:

```javascript
catch (error) {
  const errorMsg = error?.message || String(error);
  if (errorMsg.includes('-10868') || errorMsg.includes('could not start the audio engine')) {
    throw new Error(
      'Failed to start detector: Audio system conflict detected. ' +
      'Please close and reopen the app, then try again.'
    );
  }
  throw error;
}
```

## Files Modified

1. **Patch file:** `patches/@cjblack+expo-audio-stream+0.2.26.patch`
   - Enhanced audio engine cleanup before tap installation
   - Added format validation logging

2. **Detection engine:** `services/dsp/VideoSyncDetectorV2.js`
   - Added retry logic for audio session conflicts
   - Improved error handling and user messaging

## Testing Instructions

To verify the fix:

1. **Rebuild the app** (native changes require rebuild):
   ```bash
   eas build --platform ios --profile development
   ```

2. **Test scenario:**
   - Open the app (video starts playing automatically)
   - **Immediately** tap the "Listen Mode" toggle
   - Expected: Detector should start without crashing
   - If it fails once, it should retry and succeed on second attempt

3. **Alternative test:**
   - Open app ‚Üí wait for video to play
   - Switch between sound types (Tone/Beat/Wind)
   - Enable Listen Mode
   - Should work without crashes

4. **Logging to watch for:**
   ```
   Debug: Stopping audio engine before tap installation
   Debug: Checking for existing tap before installation
   Debug: Input node format - SR: 48000Hz, CH: 1
   üéôÔ∏è Starting audio stream recording (attempt 1/2)
   ‚úÖ Audio stream recording started successfully
   ```

## Expected Behavior After Fix

- ‚úÖ No crash when switching to detector mode immediately after app launch
- ‚úÖ Retry logic handles transient audio session conflicts
- ‚úÖ Clear error messages if issue persists
- ‚úÖ Proper cleanup of audio resources

## Deployment

This fix requires:
1. **Native rebuild** (iOS changes in Swift code)
2. **New TestFlight build** for testing
3. **App Store submission** once verified

**Build command:**
```bash
# For TestFlight testing
eas build --platform ios --profile preview

# For App Store submission
eas build --platform ios --profile production
```

## Future Considerations

If this issue persists, consider:

1. **Coordination between expo-video and audio recording:**
   - Implement explicit audio session handoff
   - Use notifications to coordinate session changes

2. **Longer retry delays:**
   - Increase retry delay from 300ms to 500ms if needed
   - Add exponential backoff

3. **Audio session monitoring:**
   - Add listeners for AVAudioSession interruption notifications
   - Automatically handle session changes from other apps

## Related Files

- Crash log: `Documents/testflight_feedback/crashlog.crash`
- Feedback: `Documents/testflight_feedback/feedback.json`
- Hook: `hooks/useVideoSyncDetector.js`
- HomeScreen: `screens/HomeScreen.js`
